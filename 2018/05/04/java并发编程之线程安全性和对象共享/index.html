<!DOCTYPE html>
<html>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="读书笔记来自《java并发编程实战》。 线程安全性可重入锁 可重入意味着获取锁的操作的粒度是线程而不是调用。 实现方法是为每个锁关联一个获取计数值和一个所有者进程。当计数器为0，这个锁被认为可以被任何线程池游。当线程请求一个未被池游的锁时，JVM将记下锁的持有者，并且将计数器置为1，如果同一个线程再次获取这个锁，计数器将递增。当线程退出痛不快，计数器递减。当计数器为0，锁被释放。  对象的共享可见">
<meta name="keywords" content="java并发">
<meta property="og:type" content="article">
<meta property="og:title" content="java并发编程之线程安全性和对象共享">
<meta property="og:url" content="http://imwyy.github.io/2018/05/04/java并发编程之线程安全性和对象共享/index.html">
<meta property="og:site_name" content="stpehen的博客">
<meta property="og:description" content="读书笔记来自《java并发编程实战》。 线程安全性可重入锁 可重入意味着获取锁的操作的粒度是线程而不是调用。 实现方法是为每个锁关联一个获取计数值和一个所有者进程。当计数器为0，这个锁被认为可以被任何线程池游。当线程请求一个未被池游的锁时，JVM将记下锁的持有者，并且将计数器置为1，如果同一个线程再次获取这个锁，计数器将递增。当线程退出痛不快，计数器递减。当计数器为0，锁被释放。  对象的共享可见">
<meta property="og:updated_time" content="2018-05-04T13:11:33.612Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="java并发编程之线程安全性和对象共享">
<meta name="twitter:description" content="读书笔记来自《java并发编程实战》。 线程安全性可重入锁 可重入意味着获取锁的操作的粒度是线程而不是调用。 实现方法是为每个锁关联一个获取计数值和一个所有者进程。当计数器为0，这个锁被认为可以被任何线程池游。当线程请求一个未被池游的锁时，JVM将记下锁的持有者，并且将计数器置为1，如果同一个线程再次获取这个锁，计数器将递增。当线程退出痛不快，计数器递减。当计数器为0，锁被释放。  对象的共享可见">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>java并发编程之线程安全性和对象共享</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Inici</a></li>
         
          <li><a href="/about/">Qui som</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/projects_url">Projectes</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2018/05/04/java并发编程之对象组合/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2018/03/15/分布式事务的提交：二阶段和三阶段/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Post Anterior</span>
      <span id="i-next" class="info" style="display:none;">Post Següent</span>
      <span id="i-top" class="info" style="display:none;">Adalt</span>
      <span id="i-share" class="info" style="display:none;">Compartir Post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://imwyy.github.io/2018/05/04/java并发编程之线程安全性和对象共享/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://imwyy.github.io/2018/05/04/java并发编程之线程安全性和对象共享/&text=java并发编程之线程安全性和对象共享"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://imwyy.github.io/2018/05/04/java并发编程之线程安全性和对象共享/&title=java并发编程之线程安全性和对象共享"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://imwyy.github.io/2018/05/04/java并发编程之线程安全性和对象共享/&is_video=false&description=java并发编程之线程安全性和对象共享"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=java并发编程之线程安全性和对象共享&body=Check out this article: http://imwyy.github.io/2018/05/04/java并发编程之线程安全性和对象共享/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://imwyy.github.io/2018/05/04/java并发编程之线程安全性和对象共享/&title=java并发编程之线程安全性和对象共享"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://imwyy.github.io/2018/05/04/java并发编程之线程安全性和对象共享/&title=java并发编程之线程安全性和对象共享"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://imwyy.github.io/2018/05/04/java并发编程之线程安全性和对象共享/&title=java并发编程之线程安全性和对象共享"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://imwyy.github.io/2018/05/04/java并发编程之线程安全性和对象共享/&title=java并发编程之线程安全性和对象共享"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://imwyy.github.io/2018/05/04/java并发编程之线程安全性和对象共享/&name=java并发编程之线程安全性和对象共享&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#线程安全性"><span class="toc-number">1.</span> <span class="toc-text"><a href="#&#x7EBF;&#x7A0B;&#x5B89;&#x5168;&#x6027;" class="headerlink" title="&#x7EBF;&#x7A0B;&#x5B89;&#x5168;&#x6027;"></a>&#x7EBF;&#x7A0B;&#x5B89;&#x5168;&#x6027;</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#可重入锁"><span class="toc-number">1.1.</span> <span class="toc-text"><a href="#&#x53EF;&#x91CD;&#x5165;&#x9501;" class="headerlink" title="&#x53EF;&#x91CD;&#x5165;&#x9501;"></a>&#x53EF;&#x91CD;&#x5165;&#x9501;</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#对象的共享"><span class="toc-number">2.</span> <span class="toc-text"><a href="#&#x5BF9;&#x8C61;&#x7684;&#x5171;&#x4EAB;" class="headerlink" title="&#x5BF9;&#x8C61;&#x7684;&#x5171;&#x4EAB;"></a>&#x5BF9;&#x8C61;&#x7684;&#x5171;&#x4EAB;</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#可见性"><span class="toc-number">2.1.</span> <span class="toc-text"><a href="#&#x53EF;&#x89C1;&#x6027;" class="headerlink" title="&#x53EF;&#x89C1;&#x6027;"></a>&#x53EF;&#x89C1;&#x6027;</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#volatile关键字"><span class="toc-number">2.1.0.1.</span> <span class="toc-text"><a href="#volatile&#x5173;&#x952E;&#x5B57;" class="headerlink" title="volatile&#x5173;&#x952E;&#x5B57;"></a>volatile&#x5173;&#x952E;&#x5B57;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#加锁可以保证可见性"><span class="toc-number">2.1.0.2.</span> <span class="toc-text"><a href="#&#x52A0;&#x9501;&#x53EF;&#x4EE5;&#x4FDD;&#x8BC1;&#x53EF;&#x89C1;&#x6027;" class="headerlink" title="&#x52A0;&#x9501;&#x53EF;&#x4EE5;&#x4FDD;&#x8BC1;&#x53EF;&#x89C1;&#x6027;"></a>&#x52A0;&#x9501;&#x53EF;&#x4EE5;&#x4FDD;&#x8BC1;&#x53EF;&#x89C1;&#x6027;</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#发布和逸出"><span class="toc-number">2.2.</span> <span class="toc-text"><a href="#&#x53D1;&#x5E03;&#x548C;&#x9038;&#x51FA;" class="headerlink" title="&#x53D1;&#x5E03;&#x548C;&#x9038;&#x51FA;"></a>&#x53D1;&#x5E03;&#x548C;&#x9038;&#x51FA;</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#this引用逸出"><span class="toc-number">2.2.0.1.</span> <span class="toc-text"><a href="#this&#x5F15;&#x7528;&#x9038;&#x51FA;" class="headerlink" title="this&#x5F15;&#x7528;&#x9038;&#x51FA;"></a>this&#x5F15;&#x7528;&#x9038;&#x51FA;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安全的对象构造过程"><span class="toc-number">2.2.0.2.</span> <span class="toc-text"><a href="#&#x5B89;&#x5168;&#x7684;&#x5BF9;&#x8C61;&#x6784;&#x9020;&#x8FC7;&#x7A0B;" class="headerlink" title="&#x5B89;&#x5168;&#x7684;&#x5BF9;&#x8C61;&#x6784;&#x9020;&#x8FC7;&#x7A0B;"></a>&#x5B89;&#x5168;&#x7684;&#x5BF9;&#x8C61;&#x6784;&#x9020;&#x8FC7;&#x7A0B;</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#线程封闭"><span class="toc-number">2.3.</span> <span class="toc-text"><a href="#&#x7EBF;&#x7A0B;&#x5C01;&#x95ED;" class="headerlink" title="&#x7EBF;&#x7A0B;&#x5C01;&#x95ED;"></a>&#x7EBF;&#x7A0B;&#x5C01;&#x95ED;</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Ad-hoc线程封闭"><span class="toc-number">2.3.0.1.</span> <span class="toc-text"><a href="#Ad-hoc&#x7EBF;&#x7A0B;&#x5C01;&#x95ED;" class="headerlink" title="Ad-hoc&#x7EBF;&#x7A0B;&#x5C01;&#x95ED;"></a>Ad-hoc&#x7EBF;&#x7A0B;&#x5C01;&#x95ED;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#栈封闭"><span class="toc-number">2.3.0.2.</span> <span class="toc-text"><a href="#&#x6808;&#x5C01;&#x95ED;" class="headerlink" title="&#x6808;&#x5C01;&#x95ED;"></a>&#x6808;&#x5C01;&#x95ED;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Threadlocal类"><span class="toc-number">2.3.0.3.</span> <span class="toc-text"><a href="#Threadlocal&#x7C7B;" class="headerlink" title="Threadlocal&#x7C7B;"></a>Threadlocal&#x7C7B;</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#不变性"><span class="toc-number">2.4.</span> <span class="toc-text"><a href="#&#x4E0D;&#x53D8;&#x6027;" class="headerlink" title="&#x4E0D;&#x53D8;&#x6027;"></a>&#x4E0D;&#x53D8;&#x6027;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安全发布"><span class="toc-number">2.5.</span> <span class="toc-text"><a href="#&#x5B89;&#x5168;&#x53D1;&#x5E03;" class="headerlink" title="&#x5B89;&#x5168;&#x53D1;&#x5E03;"></a>&#x5B89;&#x5168;&#x53D1;&#x5E03;</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#利用容器"><span class="toc-number">2.5.0.1.</span> <span class="toc-text"><a href="#&#x5229;&#x7528;&#x5BB9;&#x5668;" class="headerlink" title="&#x5229;&#x7528;&#x5BB9;&#x5668;"></a>&#x5229;&#x7528;&#x5BB9;&#x5668;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#利用静态变量"><span class="toc-number">2.5.0.2.</span> <span class="toc-text"><a href="#&#x5229;&#x7528;&#x9759;&#x6001;&#x53D8;&#x91CF;" class="headerlink" title="&#x5229;&#x7528;&#x9759;&#x6001;&#x53D8;&#x91CF;"></a>&#x5229;&#x7528;&#x9759;&#x6001;&#x53D8;&#x91CF;</span></a></li></ol></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        java并发编程之线程安全性和对象共享
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">stpehen的博客</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2018-05-04T13:10:32.000Z" itemprop="datePublished">2018-05-04</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/java/">java</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/java并发/">java并发</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>读书笔记来自《java并发编程实战》。</p>
<h1 id="线程安全性"><a href="#线程安全性" class="headerlink" title="线程安全性"></a>线程安全性</h1><h2 id="可重入锁"><a href="#可重入锁" class="headerlink" title="可重入锁"></a>可重入锁</h2><ul>
<li>可重入意味着获取锁的操作的粒度是线程而不是调用。</li>
<li>实现方法是为每个锁关联一个获取计数值和一个所有者进程。当计数器为0，这个锁被认为可以被任何线程池游。当线程请求一个未被池游的锁时，JVM将记下锁的持有者，并且将计数器置为1，如果同一个线程再次获取这个锁，计数器将递增。当线程退出痛不快，计数器递减。当计数器为0，锁被释放。</li>
</ul>
<h1 id="对象的共享"><a href="#对象的共享" class="headerlink" title="对象的共享"></a>对象的共享</h1><h2 id="可见性"><a href="#可见性" class="headerlink" title="可见性"></a>可见性</h2><h4 id="volatile关键字"><a href="#volatile关键字" class="headerlink" title="volatile关键字"></a>volatile关键字</h4><p>并发需要三点必须满足的特性</p>
<ul>
<li>原子性：即一个操作或者多个操作 要么全部执行并且执行的过程不会被任何因素打断，要么就都不执行。</li>
<li>可见性：多个线程访问一个变量，其他线程能看到变量的改变</li>
<li>有序性：即程序执行的顺序按照代码的先后顺序执行。</li>
</ul>
<p>volatile满足了可见性和有序性，没有办法满足原子性。实现原理是，每个线程的工作内存中，复制了变量的值（源自cpu缓存，防止每次都去主存获取）。当某个线程更改变量的值，其他线程的缓存失效，必须去主存重新获取。更改完成立马写回主存。</p>
<p>所以使用volatile的场景是能够保证操作原子性的情况变量的更改不依赖于当前值，或者可以确保只有单个线程更新变量的值。</p>
<h4 id="加锁可以保证可见性"><a href="#加锁可以保证可见性" class="headerlink" title="加锁可以保证可见性"></a>加锁可以保证可见性</h4><p>加锁不仅局限于互斥行为，还包括了内存可见性。</p>
<h2 id="发布和逸出"><a href="#发布和逸出" class="headerlink" title="发布和逸出"></a>发布和逸出</h2><h4 id="this引用逸出"><a href="#this引用逸出" class="headerlink" title="this引用逸出"></a>this引用逸出</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThisEscape</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ThisEscape</span> <span class="params">(EventSource source)</span></span>&#123;</span><br><span class="line">		source.registerListener&#123;</span><br><span class="line">			<span class="keyword">new</span> EventListener()&#123;</span><br><span class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(Event e)</span></span>&#123;</span><br><span class="line">					doSomething(e);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在对象没有确定完全初始化之前就发布了this引用。在构造函数中注册了监听事件，但是此时ThisEscape对象还没有完全初始化。</p>
<h4 id="安全的对象构造过程"><a href="#安全的对象构造过程" class="headerlink" title="安全的对象构造过程"></a>安全的对象构造过程</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SafeListener</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> EventListener listener;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">SafeListener</span><span class="params">()</span></span>&#123;</span><br><span class="line">		listener =<span class="keyword">new</span> EventListener()&#123;</span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(Event e)</span></span>&#123;</span><br><span class="line">				doSomething(e);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SafeListener <span class="title">newInstance</span><span class="params">(EventSource source)</span></span>&#123;</span><br><span class="line">		SafeListener safe=<span class="keyword">new</span> SafeListener();</span><br><span class="line">		source.registerListener(safe.listener);</span><br><span class="line">		<span class="keyword">return</span> safe;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在执行<code>source.registerListener(safe.listener);</code>之前， SafeListener已经完全初始化。</p>
<h2 id="线程封闭"><a href="#线程封闭" class="headerlink" title="线程封闭"></a>线程封闭</h2><h4 id="Ad-hoc线程封闭"><a href="#Ad-hoc线程封闭" class="headerlink" title="Ad-hoc线程封闭"></a>Ad-hoc线程封闭</h4><p>完全由程序控制维护线程的封闭性，十分脆弱，尽量要少用。</p>
<h4 id="栈封闭"><a href="#栈封闭" class="headerlink" title="栈封闭"></a>栈封闭</h4><p>即使用的变量均为局部变量，每次调用方法都会把局部变量压栈，同样也不存在线程安全的问题。</p>
<p>但是注意不可以对传入的引用做修改（函数副作用）或者发布方法中的一个引用（如集合引用），这样会导致逸出，带来线程安全问题。且不易维护。</p>
<h4 id="Threadlocal类"><a href="#Threadlocal类" class="headerlink" title="Threadlocal类"></a>Threadlocal类</h4><p>在每个线程中都有一份变量的备份，实现原理是利用map（ThreadlocalMap， key是threadlocal）。解决了对于每个线程都使用的变量需要同步的问题，比如创建数据库的连接，session管理。</p>
<p>实现应用程序框架时，使用了大量的Threadlocal。如EJB调用，J2EE需要将一个事务上下文与某个执行中的线程关联起来。通过将事物上下文保存在静态的Threadlocal中实现。当框架需要知道当前运行的是哪一个事务的时候，只要从Threadlocal中读取上下文。</p>
<p>这种方法会降低代码的可重用性，带来隐含的耦合。使用时需要小心。</p>
<h2 id="不变性"><a href="#不变性" class="headerlink" title="不变性"></a>不变性</h2><p>不可变对象一定是线程安全的。</p>
<p>如何构造一个不变的类。</p>
<ul>
<li>final修饰变量和类</li>
<li>不提供setter方法</li>
<li>构造方法里初始化所有的值</li>
<li>getter方法返回值的clone</li>
<li>对象的clone采用深度复制</li>
<li>类成员变量被修饰成private</li>
</ul>
<h2 id="安全发布"><a href="#安全发布" class="headerlink" title="安全发布"></a>安全发布</h2><p>安全地发布一个对象，对象的应用以及对象的状态必须同时对其他线程可见。一个正确构造的对象可以通过以下方式来安全地发布：</p>
<ul>
<li>在静态初始化函数中初始化一个对象引用</li>
<li>将对象的应用保存到volatile类型的域或者AtomicReferance对象中</li>
<li>将对象的引用保存到某个正确构造对象的final类型域中</li>
<li>将对象的引用保存到一个由锁保护的域中</li>
</ul>
<h4 id="利用容器"><a href="#利用容器" class="headerlink" title="利用容器"></a>利用容器</h4><p>线程安全库中的容器类提供了以下的安全发布保证：</p>
<ul>
<li>通过将一个键或者值放入Hashtable、synchronizedMap或者ConcurrentMap中，可以安全地将它发布给任何从这些容器中访问它的线程（无论是直接访问还是通过迭代器访问）</li>
<li>通过将某个元素放入Vector、CopyOnWriteArrayList、CopyOnWriteArraySet、synchronizedList或synchronizedSet中，可以将该元素安全地发布到任何从这些容器中访问该元素的线程</li>
<li>通过将某个元素放入BlockingQueue或者ConcurrentLinkedQueue中，可以将该元素安全地发布到任何从这些队列中访问该元素的线程。</li>
<li>类库中的其他数据传递机制（例如Future和Exchanger）同样能实现安全发布。</li>
</ul>
<h4 id="利用静态变量"><a href="#利用静态变量" class="headerlink" title="利用静态变量"></a>利用静态变量</h4><p>静态初始化器由JVM在类的初始化阶段执行。由于在JVM内部存在着同步机制，因此通过这种方式初始化的任何对象都可以被安全地发布</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Inici</a></li>
         
          <li><a href="/about/">Qui som</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/projects_url">Projectes</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#线程安全性"><span class="toc-number">1.</span> <span class="toc-text"><a href="#&#x7EBF;&#x7A0B;&#x5B89;&#x5168;&#x6027;" class="headerlink" title="&#x7EBF;&#x7A0B;&#x5B89;&#x5168;&#x6027;"></a>&#x7EBF;&#x7A0B;&#x5B89;&#x5168;&#x6027;</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#可重入锁"><span class="toc-number">1.1.</span> <span class="toc-text"><a href="#&#x53EF;&#x91CD;&#x5165;&#x9501;" class="headerlink" title="&#x53EF;&#x91CD;&#x5165;&#x9501;"></a>&#x53EF;&#x91CD;&#x5165;&#x9501;</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#对象的共享"><span class="toc-number">2.</span> <span class="toc-text"><a href="#&#x5BF9;&#x8C61;&#x7684;&#x5171;&#x4EAB;" class="headerlink" title="&#x5BF9;&#x8C61;&#x7684;&#x5171;&#x4EAB;"></a>&#x5BF9;&#x8C61;&#x7684;&#x5171;&#x4EAB;</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#可见性"><span class="toc-number">2.1.</span> <span class="toc-text"><a href="#&#x53EF;&#x89C1;&#x6027;" class="headerlink" title="&#x53EF;&#x89C1;&#x6027;"></a>&#x53EF;&#x89C1;&#x6027;</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#volatile关键字"><span class="toc-number">2.1.0.1.</span> <span class="toc-text"><a href="#volatile&#x5173;&#x952E;&#x5B57;" class="headerlink" title="volatile&#x5173;&#x952E;&#x5B57;"></a>volatile&#x5173;&#x952E;&#x5B57;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#加锁可以保证可见性"><span class="toc-number">2.1.0.2.</span> <span class="toc-text"><a href="#&#x52A0;&#x9501;&#x53EF;&#x4EE5;&#x4FDD;&#x8BC1;&#x53EF;&#x89C1;&#x6027;" class="headerlink" title="&#x52A0;&#x9501;&#x53EF;&#x4EE5;&#x4FDD;&#x8BC1;&#x53EF;&#x89C1;&#x6027;"></a>&#x52A0;&#x9501;&#x53EF;&#x4EE5;&#x4FDD;&#x8BC1;&#x53EF;&#x89C1;&#x6027;</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#发布和逸出"><span class="toc-number">2.2.</span> <span class="toc-text"><a href="#&#x53D1;&#x5E03;&#x548C;&#x9038;&#x51FA;" class="headerlink" title="&#x53D1;&#x5E03;&#x548C;&#x9038;&#x51FA;"></a>&#x53D1;&#x5E03;&#x548C;&#x9038;&#x51FA;</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#this引用逸出"><span class="toc-number">2.2.0.1.</span> <span class="toc-text"><a href="#this&#x5F15;&#x7528;&#x9038;&#x51FA;" class="headerlink" title="this&#x5F15;&#x7528;&#x9038;&#x51FA;"></a>this&#x5F15;&#x7528;&#x9038;&#x51FA;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安全的对象构造过程"><span class="toc-number">2.2.0.2.</span> <span class="toc-text"><a href="#&#x5B89;&#x5168;&#x7684;&#x5BF9;&#x8C61;&#x6784;&#x9020;&#x8FC7;&#x7A0B;" class="headerlink" title="&#x5B89;&#x5168;&#x7684;&#x5BF9;&#x8C61;&#x6784;&#x9020;&#x8FC7;&#x7A0B;"></a>&#x5B89;&#x5168;&#x7684;&#x5BF9;&#x8C61;&#x6784;&#x9020;&#x8FC7;&#x7A0B;</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#线程封闭"><span class="toc-number">2.3.</span> <span class="toc-text"><a href="#&#x7EBF;&#x7A0B;&#x5C01;&#x95ED;" class="headerlink" title="&#x7EBF;&#x7A0B;&#x5C01;&#x95ED;"></a>&#x7EBF;&#x7A0B;&#x5C01;&#x95ED;</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Ad-hoc线程封闭"><span class="toc-number">2.3.0.1.</span> <span class="toc-text"><a href="#Ad-hoc&#x7EBF;&#x7A0B;&#x5C01;&#x95ED;" class="headerlink" title="Ad-hoc&#x7EBF;&#x7A0B;&#x5C01;&#x95ED;"></a>Ad-hoc&#x7EBF;&#x7A0B;&#x5C01;&#x95ED;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#栈封闭"><span class="toc-number">2.3.0.2.</span> <span class="toc-text"><a href="#&#x6808;&#x5C01;&#x95ED;" class="headerlink" title="&#x6808;&#x5C01;&#x95ED;"></a>&#x6808;&#x5C01;&#x95ED;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Threadlocal类"><span class="toc-number">2.3.0.3.</span> <span class="toc-text"><a href="#Threadlocal&#x7C7B;" class="headerlink" title="Threadlocal&#x7C7B;"></a>Threadlocal&#x7C7B;</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#不变性"><span class="toc-number">2.4.</span> <span class="toc-text"><a href="#&#x4E0D;&#x53D8;&#x6027;" class="headerlink" title="&#x4E0D;&#x53D8;&#x6027;"></a>&#x4E0D;&#x53D8;&#x6027;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安全发布"><span class="toc-number">2.5.</span> <span class="toc-text"><a href="#&#x5B89;&#x5168;&#x53D1;&#x5E03;" class="headerlink" title="&#x5B89;&#x5168;&#x53D1;&#x5E03;"></a>&#x5B89;&#x5168;&#x53D1;&#x5E03;</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#利用容器"><span class="toc-number">2.5.0.1.</span> <span class="toc-text"><a href="#&#x5229;&#x7528;&#x5BB9;&#x5668;" class="headerlink" title="&#x5229;&#x7528;&#x5BB9;&#x5668;"></a>&#x5229;&#x7528;&#x5BB9;&#x5668;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#利用静态变量"><span class="toc-number">2.5.0.2.</span> <span class="toc-text"><a href="#&#x5229;&#x7528;&#x9759;&#x6001;&#x53D8;&#x91CF;" class="headerlink" title="&#x5229;&#x7528;&#x9759;&#x6001;&#x53D8;&#x91CF;"></a>&#x5229;&#x7528;&#x9759;&#x6001;&#x53D8;&#x91CF;</span></a></li></ol></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://imwyy.github.io/2018/05/04/java并发编程之线程安全性和对象共享/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://imwyy.github.io/2018/05/04/java并发编程之线程安全性和对象共享/&text=java并发编程之线程安全性和对象共享"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://imwyy.github.io/2018/05/04/java并发编程之线程安全性和对象共享/&title=java并发编程之线程安全性和对象共享"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://imwyy.github.io/2018/05/04/java并发编程之线程安全性和对象共享/&is_video=false&description=java并发编程之线程安全性和对象共享"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=java并发编程之线程安全性和对象共享&body=Check out this article: http://imwyy.github.io/2018/05/04/java并发编程之线程安全性和对象共享/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://imwyy.github.io/2018/05/04/java并发编程之线程安全性和对象共享/&title=java并发编程之线程安全性和对象共享"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://imwyy.github.io/2018/05/04/java并发编程之线程安全性和对象共享/&title=java并发编程之线程安全性和对象共享"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://imwyy.github.io/2018/05/04/java并发编程之线程安全性和对象共享/&title=java并发编程之线程安全性和对象共享"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://imwyy.github.io/2018/05/04/java并发编程之线程安全性和对象共享/&title=java并发编程之线程安全性和对象共享"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://imwyy.github.io/2018/05/04/java并发编程之线程安全性和对象共享/&name=java并发编程之线程安全性和对象共享&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menú</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Compartir</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Cap amunt</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 stpehen
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Inici</a></li>
         
          <li><a href="/about/">Qui som</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/projects_url">Projectes</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
