<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>netty高性能调优 | A Programmer</title>
  <meta name="description" content="netty关于netty的学习和介绍，可以去github看官方文档，这里良心推荐《netty实战》和《netty权威指南》两本书，前者对于新手更友好，原理和应用都有讲到，多读读会发现很多高性能的优化点。 netty高性能优化点最近参加了阿里中间价性能比赛，为了提升netty写的servive mesh的网络通信的性能，最近几天查了书、博客（这里强力推荐netty作者的博客，干货真的很多），自己总结">
<meta property="og:type" content="article">
<meta property="og:title" content="netty高性能调优">
<meta property="og:url" content="http://imwyy.github.io/2018/06/19/netty高性能调优/index.html">
<meta property="og:site_name" content="stpehac的博客">
<meta property="og:description" content="netty关于netty的学习和介绍，可以去github看官方文档，这里良心推荐《netty实战》和《netty权威指南》两本书，前者对于新手更友好，原理和应用都有讲到，多读读会发现很多高性能的优化点。 netty高性能优化点最近参加了阿里中间价性能比赛，为了提升netty写的servive mesh的网络通信的性能，最近几天查了书、博客（这里强力推荐netty作者的博客，干货真的很多），自己总结">
<meta property="og:image" content="http://raw.githubusercontent.com/IMWYY/AboutMyself/master/picBed/Screenshot1529394914.png">
<meta property="og:image" content="http://raw.githubusercontent.com/IMWYY/AboutMyself/master/picBed/Screenshot1529400921.png">
<meta property="og:updated_time" content="2018-06-19T09:45:56.926Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="netty高性能调优">
<meta name="twitter:description" content="netty关于netty的学习和介绍，可以去github看官方文档，这里良心推荐《netty实战》和《netty权威指南》两本书，前者对于新手更友好，原理和应用都有讲到，多读读会发现很多高性能的优化点。 netty高性能优化点最近参加了阿里中间价性能比赛，为了提升netty写的servive mesh的网络通信的性能，最近几天查了书、博客（这里强力推荐netty作者的博客，干货真的很多），自己总结">
<meta name="twitter:image" content="http://raw.githubusercontent.com/IMWYY/AboutMyself/master/picBed/Screenshot1529394914.png">
  <!-- Canonical links -->
  <link rel="canonical" href="http://imwyy.github.io/2018/06/19/netty高性能调优/index.html">
  
    <link rel="alternate" href="/atom.xml" title="stpehac的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/head.jpg" type="image/x-icon">
  
  <!-- font-awesome CSS -->
  <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  
    
    

</head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/IMWYY" target="_blank">
          <img class="img-circle img-rotate" src="/images/head.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">stephen</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">What The f__k</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="fa fa-map-marker"></i> Nanjing, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="fa fa-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="Type something..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      <!-- <span class="ins-close ins-selectable"><i class="fa fa-times"></i></span> -->
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav">
        
        
        
        <li class="menu-item menu-item-home">
          <a href="/">
            
            <i class="fa fa-fw fa-dashboard"></i>
            
            <span class="menu-title">Home</span>
          </a>
        </li>
        
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="fa fa-fw fa-delicious"></i>
            
            <span class="menu-title">Archives</span>
          </a>
        </li>
        
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="fa fa-fw fa-folder"></i>
            
            <span class="menu-title">Categories</span>
          </a>
        </li>
        
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="fa fa-fw fa-tags"></i>
            
            <span class="menu-title">Tags</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/IMWYY" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="fa fa-github"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">Board</h3>
    <div class="widget-body">
        <div id="board">
            
            <p>您好，您是第<span id="busuanzi_value_site_uv">0</span>位访客</p>
            
            <div class="content">
                
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">Categories</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/android/">android</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/leetcode/">leetcode</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/shell/">shell</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/小玩意/">小玩意</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/干货/">干货</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/并发/">并发</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/踩坑/">踩坑</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tags</h3>
    <div class="widget-body">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/">android</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java-EE/">java EE</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java并发/">java并发</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode/">leetcode</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/">shell</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/">spring</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/安装和配置/">安装和配置</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/小玩意/">小玩意</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/干货/">干货</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/并发/">并发</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库/">数据库</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库事务/">数据库事务</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库锁/">数据库锁</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/踩坑/">踩坑</a><span class="tag-list-count">5</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Archive</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">16</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2018/06/19/netty高性能调优/" class="title">netty高性能调优</a>
              </p>
              <p class="item-date">
                <time datetime="2018-06-19T09:45:13.000Z" itemprop="datePublished">2018-06-19</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2018/05/08/数据库MVCC机制/" class="title">数据库MVCC机制</a>
              </p>
              <p class="item-date">
                <time datetime="2018-05-07T16:01:33.000Z" itemprop="datePublished">2018-05-08</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2018/05/06/rxjava-retrofit封装处理网络请求-1/" class="title">rxjava+retrofit封装处理网络请求</a>
              </p>
              <p class="item-date">
                <time datetime="2018-05-06T15:18:15.000Z" itemprop="datePublished">2018-05-06</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2018/05/06/rxjava-retrofit封装处理网络请求/" class="title">rxjava+retrofit封装处理网络请求</a>
              </p>
              <p class="item-date">
                <time datetime="2018-05-06T15:17:43.000Z" itemprop="datePublished">2018-05-06</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/android/">android</a>
              </p>
              <p class="item-title">
                <a href="/2018/05/06/rxjava+retrofit封装处理网络请求/" class="title">rxjava2+retrofit封装处理网络请求全解析</a>
              </p>
              <p class="item-date">
                <time datetime="2018-05-06T15:17:37.000Z" itemprop="datePublished">2018-05-06</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<main class="main" role="main">
  <div class="content">
  <article id="post-netty高性能调优" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      netty高性能调优
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="fa fa-calendar-check-o"></i>
	<a href="/2018/06/19/netty高性能调优/" class="article-date">
	  <time datetime="2018-06-19T09:45:13.000Z" itemprop="datePublished">2018-06-19</time>
	</a>
</span>
        
        

        
	<span class="article-read hidden-xs">
	    <i class="fa fa-eye" aria-hidden="true"></i>
	    <span id="busuanzi_container_page_pv">
			<span id="busuanzi_value_page_pv">0</span>
		</span>
	</span>


        <span class="post-comment"><i class="fa fa-commenting-o"></i> <a href="/2018/06/19/netty高性能调优/#comments" class="article-comment-link">Comments</a></span>
        
	
		<span class="post-wordcount hidden-xs" itemprop="wordCount">Word Count: 1,850(words)</span>
	
	
		<span class="post-readcount hidden-xs" itemprop="timeRequired">Read Count: 8(minutes)</span>
	

      </div>
      
    </div>
    <div class="article-entry markdown-body" itemprop="articleBody">
      
        <h2 id="netty"><a href="#netty" class="headerlink" title="netty"></a>netty</h2><p>关于netty的学习和介绍，可以去github看官方文档，这里良心推荐《netty实战》和《netty权威指南》两本书，前者对于新手更友好，原理和应用都有讲到，多读读会发现很多高性能的优化点。</p>
<h2 id="netty高性能优化点"><a href="#netty高性能优化点" class="headerlink" title="netty高性能优化点"></a>netty高性能优化点</h2><p>最近参加了阿里中间价性能比赛，为了提升netty写的servive mesh的网络通信的性能，最近几天查了书、博客（这里强力推荐netty作者的博客，干货真的很多），自己总结了如下一下优化点。如果有错误希望能指正。</p>
<p>注：这里所讨论的对应的netty版本为netty4</p>
<p>首先要明确要netty优化的几个主要的关注点。</p>
<ol>
<li>减少线程切换的开销。</li>
<li>复用channel，可以选择池化channel </li>
<li>zero copy的应用</li>
<li>减少并发下的竞态情况</li>
</ol>
<p>接下来将细数一下总结的优化点</p>
<h4 id="1-尽可能的复用EventLoopGroup。"><a href="#1-尽可能的复用EventLoopGroup。" class="headerlink" title="1. 尽可能的复用EventLoopGroup。"></a>1. <strong>尽可能的复用<code>EventLoopGroup</code>。</strong></h4><p>这里就要涉及netty的线程模型了。netty实战的第七章里有很细致的阐释。简单说<code>EventLoopGroup</code>包含了指定数量（如果没有指定，默认是cpu核数的两倍，可以从源码中看到）的<code>EvenetLoop</code>，<code>Eve netLoop</code>和<code>channel</code>的关系是一对多，一个<code>channel</code>被分配给一个<code>EventLoop</code>，它生命周期中都会使用这个<code>EventLoop</code>，而<code>EventLoop</code>背后就是线程。见下图。</p>
<blockquote>
<p>因此如果需要使用<code>ThreadLocal</code>保存上下文，那么许多channel就会共享同一个上下文。</p>
</blockquote>
<p><img src="http://raw.githubusercontent.com/IMWYY/AboutMyself/master/picBed/Screenshot1529394914.png" alt=""></p>
<p> 因此不需要每次都new出一个<code>EventLoopGroup</code>，其本质上是线程分配，<strong>可以复用同一个<code>EventLoopGroup</code>，减少资源的使用和线程的切换</strong>。特别是在服务端引导一个客户端连接的时候。如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">bootstrap.group(<span class="keyword">new</span> NioEventLoopGroup(), <span class="keyword">new</span> NioEventLoopGroup())</span><br><span class="line">        .channel(NioServerSocketChannel.class)</span><br><span class="line">        .childHandler(<span class="keyword">new</span> SimpleChannelInboundHandler&lt;ByteBuf&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, ByteBuf byteBuf)</span> </span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">                bootstrap.channel(NioSocketChannel.class)</span><br><span class="line">                    .group(ctx.channel().eventLoop())</span><br><span class="line">                    .handler(<span class="keyword">new</span> SimpleChannelInboundHandler&lt;ByteBuf&gt;() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in)</span> </span></span><br><span class="line"><span class="function">                                <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                                System.out.println(<span class="string">"Received data"</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                ChannelFuture future =  bootstrap.connect(<span class="keyword">new</span> InetSocketAddress(xxx, <span class="number">80</span>));</span><br><span class="line">                future.addListener(<span class="keyword">new</span> ChannelFutureListener() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        <span class="comment">// do something</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">bootstrap.bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">8080</span>)).sync();</span><br></pre></td></tr></table></figure>
<h4 id="2-使用EventLoop的任务调度"><a href="#2-使用EventLoop的任务调度" class="headerlink" title="2. 使用EventLoop的任务调度"></a>2. 使用<code>EventLoop</code>的任务调度</h4><p>在EventLoop的支持线程外使用channel，用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">channel.eventLoop().execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   		channel.writeAndFlush(data)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>而不是直接使用<code>channel.writeAndFlush(data)</code>；</p>
<p>前者会直接放入channel所对应的EventLoop的执行队列，而后者会导致线程的切换。</p>
<h4 id="3-减少ChannelPipline的调用长度"><a href="#3-减少ChannelPipline的调用长度" class="headerlink" title="3. 减少ChannelPipline的调用长度"></a>3. 减少ChannelPipline的调用长度</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YourHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// BAD (most of the times)</span></span><br><span class="line">    ctx.channel().writeAndFlush(msg); </span><br><span class="line">    <span class="comment">// GOOD</span></span><br><span class="line">    ctx.writeAndFlush(msg); </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>前者是将msg从整个ChannelPipline中走一遍，所有的handler都要经过，而后者是从当前handler一直到pipline的尾部，调用更短。</p>
<p>同样，为了减少pipline的长度，如果一个handler只需要使用一次，那么可以在使用过之后，将其从pipline中remove。</p>
<h4 id="4-减少ChannelHandler的创建"><a href="#4-减少ChannelHandler的创建" class="headerlink" title="4. 减少ChannelHandler的创建"></a>4. 减少ChannelHandler的创建</h4><p>如果channelhandler是无状态的（即不需要保存任何状态参数），那么使用<code>Sharable</code>注解，并在bootstrap时只创建一个实例，减少GC。否则每次连接都会new出handler对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ChannelHandler</span>.Shareable </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StatelessHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line">  	<span class="meta">@Override</span></span><br><span class="line">  	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyInitializer</span> <span class="keyword">extends</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">Channel</span>&gt; </span>&#123;</span><br><span class="line">  	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ChannelHandler INSTANCE = <span class="keyword">new</span> StatelessHandler();</span><br><span class="line">  	<span class="meta">@Override</span></span><br><span class="line">  	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(Channel ch)</span> </span>&#123;</span><br><span class="line">    	ch.pipeline().addLast(INSTANCE);</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时需要注意<code>ByteToMessageDecoder</code>之类的编解码器是有状态的，不能使用<code>Sharable</code>注解。</p>
<h4 id="5-减少系统调用（Flush）的调用"><a href="#5-减少系统调用（Flush）的调用" class="headerlink" title="5. 减少系统调用（Flush）的调用"></a>5. 减少系统调用（Flush）的调用</h4><p>flush操作是将消息发送出去，会引起系统调用，应该尽量减少flush操作，减少系统调用的开销。</p>
<p>同时也要减少write的操作， 因为这样消息会流过整个ChannelPipline。</p>
<h4 id="6-使用单链接"><a href="#6-使用单链接" class="headerlink" title="6. 使用单链接"></a>6. 使用单链接</h4><p>对于两个指定的端点可以使用单一的channel，在第一次创建之后保存channel，然后下次对于同一个IP地址可以复用该<code>channel</code>而不需要重新建立。</p>
<p>你可能需要一个map来保存对于不同ip的channel，但是在初始化时这可能会有一些线程并发的问题。在这篇微信推文（<a href="https://mp.weixin.qq.com/s/JRsbK1Un2av9GKmJ8DK7IQ）中有提到对于这个的解决方案，在蚂蚁金服的sofa-bolt项目中有类似情形，不过不太理解。" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/JRsbK1Un2av9GKmJ8DK7IQ）中有提到对于这个的解决方案，在蚂蚁金服的sofa-bolt项目中有类似情形，不过不太理解。</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">initialTask = <span class="keyword">this</span>.connTasks.get(poolKey);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">null</span> == initialTask) &#123;</span><br><span class="line">    initialTask = <span class="keyword">new</span> RunStateRecordedFutureTask&lt;ConnectionPool&gt;(callable);</span><br><span class="line">    initialTask = <span class="keyword">this</span>.connTasks.putIfAbsent(poolKey, initialTask);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == initialTask) &#123;</span><br><span class="line">        initialTask = <span class="keyword">this</span>.connTasks.get(poolKey);</span><br><span class="line">        initialTask.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7-利用netty零拷贝，在IO操作时使用池化的DirectBuffer"><a href="#7-利用netty零拷贝，在IO操作时使用池化的DirectBuffer" class="headerlink" title="7. 利用netty零拷贝，在IO操作时使用池化的DirectBuffer"></a>7. 利用netty零拷贝，在IO操作时使用池化的DirectBuffer</h4><p>在bootstrap配置参数的时候，使用<code>.option(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT)</code>来指定一个池化的Allocator，并且使用<code>ByteBuf buf = allocator.directBuffer();</code>来获取Bytebuf。</p>
<p>PooledByteBufAllocator，netty会帮你复用（无需release，除非你后面还需要用到同一个bytebuf）而不是每次都重新分配ByteBuf。在IO操作中，分配直接内存而不是JVM的堆空间，就避免了在发送数据时，从JVM到直接内存的拷贝过程，这也就是zero copy的含义。</p>
<h4 id="8-一些配置参数的设置"><a href="#8-一些配置参数的设置" class="headerlink" title="8. 一些配置参数的设置"></a>8. 一些配置参数的设置</h4><p>ServerBootstrap启动时，通常 <code>bossGroup</code> 只需要设置为 <code>1</code> 即可，因为 <code>ServerSocketChannel</code> 在初始化阶段，只会注册到某一个 <code>eventLoop</code> 上，而这个 <code>eventLoop</code> 只会有一个线程在运行，所以没有必要设置为多线程。而 IO 线程，为了充分利用 CPU，同时考虑减少线上下文切换的开销，通常设置为 CPU 核数的两倍，这也是 Netty 提供的默认值。</p>
<p>在对于响应时间有高要求的场景，使用<code>.childOption(ChannelOption.TCP_NODELAY, true)</code>和<code>.option(ChannelOption.TCP_NODELAY, true)</code>来禁用nagle算法，不等待，立即发送。</p>
<h4 id="9-小心的使用并发编程技巧"><a href="#9-小心的使用并发编程技巧" class="headerlink" title="9. 小心的使用并发编程技巧"></a>9. 小心的使用并发编程技巧</h4><p><strong>千万不要阻塞EventLoop！</strong>包括了<code>Thead.sleep()</code> <code>CountDownLatch</code> 和一些耗时的操作等等，尽量使用netty中的各种future。如果必须尽量减少重量级的锁的的使用。</p>
<ul>
<li>在使用<code>volatile</code>时，</li>
</ul>
<p>坏的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Selector selector;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  selector.select();</span><br><span class="line">  ....</span><br><span class="line">  selector.selectNow();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>好的：先将volatile变量保存到方法栈中，jdk源码中大量的使用了这种技巧。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Selector selector;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Selector selector = <span class="keyword">this</span>.selector;</span><br><span class="line">  selector.select();</span><br><span class="line">  ....</span><br><span class="line">  selector.selectNow();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用<code>Atomic*FieldUpdater</code>替换<code>Atomic*</code>。关于这个可以参考<a href="http://normanmaurer.me/blog/2013/10/28/Lesser-known-concurrent-classes-Part-1/。简单说，如果使用`Atomic*`，对于每个连接都会创建一个对象，而如果使用`Atomic*FieldUpdater`则会省去这部分的开销，只有一个`static" target="_blank" rel="noopener">http://normanmaurer.me/blog/2013/10/28/Lesser-known-concurrent-classes-Part-1/。简单说，如果使用`Atomic*`，对于每个连接都会创建一个对象，而如果使用`Atomic*FieldUpdater`则会省去这部分的开销，只有一个`static</a> final`变量。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicLongFieldUpdater&lt;TheDeclaringClass&gt; ATOMIC_UPDATER =</span><br><span class="line">        AtomicLongFieldUpdater.newUpdater(TheDeclaringClass.class, <span class="string">"atomic"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> atomic;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">yourMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ATOMIC_UPDATER.compareAndSet(<span class="keyword">this</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10-响应顺序的处理"><a href="#10-响应顺序的处理" class="headerlink" title="10. 响应顺序的处理"></a>10. 响应顺序的处理</h4><p>当使用了单链接，就有一个必须要解决的问题，将请求和响应顺序对应起来。因为所有的操作都是异步的，TCP是基于字节流的，所以channel接收到的数据无法保证和发送顺序一致。这个的解决方案就是，对于每个请求指定一个id，对于响应也携带该id。如果后发的请求的响应先到，则将其缓存起来（可以使用一个并发的队列），然后等待该id之前的所有响应全部接收到，再按序返回。</p>
<p><img src="http://raw.githubusercontent.com/IMWYY/AboutMyself/master/picBed/Screenshot1529400921.png" alt=""></p>
<p>具体实现可以参见nifty中的<a href="https://github.com/facebookarchive/nifty/blob/master/nifty-core/src/main/java/com/facebook/nifty/core/NiftyDispatcher.java" target="_blank" rel="noopener">NiftyDispatcher类</a>。</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://imwyy.github.io/2018/06/19/netty高性能调优/" title="netty高性能调优" target="_blank" rel="external">http://imwyy.github.io/2018/06/19/netty高性能调优/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/IMWYY" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/head.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/IMWYY" target="_blank"><span class="text-dark">stephen</span><small class="ml-1x">What The f__k</small></a></h3>
        <div>我真的不会码代码。</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
       
    <div id="uyan_frame"></div>

    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    
    <li class="next">
      <a href="/2018/05/08/数据库MVCC机制/" title="数据库MVCC机制">Older&nbsp;&nbsp;<i class="fa fa-angle-right" aria-hidden="true"></i></a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning hidden-xs" data-toggle="modal" data-target="#donateModal"><span>$</span></button>
  
  
  <div class="bar-right">
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
  </div>
  
  </div>
</nav>
  
<!-- Modal -->
<div class="modal modal-center modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-tit">
            <p>Thank you for your support, I will continue to work hard!</p>
          </div>
          <div class="donate-payimg">
            <img src="/images/donate/alipayimg.png" alt="Scan Qrcode" title="Scan" />
          </div>
          <p class="text-muted mv">Scan this qrcode</p>
          <div class="donate-payselect">
            <div class="pay_item checked" data-id="alipay" data-src="/images/donate/alipayimg.png">
              <div class="radio">
                <input type="radio" name="payment" id="input-alipay" value="alipay" checked>
                <label class="pay_logo clickable" for="input-alipay"><img src="/images/donate/alipay.jpg" alt="alipay" /></label>
              </div>
            </div>
            <div class="pay_item" data-id="weipay" data-src="/images/donate/weipayimg.png">
              <div class="radio">
                <input type="radio" name="payment" id="input-weipay" value="weipay">
                <label class="pay_logo clickable" for="input-weipay"><img src="/images/donate/weipay.jpg" alt="weipay" /></label>
              </div>
            </div>
          </div>
          <div class="text-grey">
            <p>Scan this qrcode, you can sweep yards reward oh!</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/IMWYY" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="fa fa-github"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
    </div>
</footer>
  <script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script src="/js/plugin.js"></script>
<script src="/js/application.js"></script>
  
    
    
    
        <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>
    
    
    
        
<script defer src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



    
    
        
    
    <script defer type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=[object Object]"></script>


    
    



</body>
</html>